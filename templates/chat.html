{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard - Cleo{% endblock %}
{% block content %}
                    <header class="page-header page-header-compact page-header-light border-bottom bg-white mb-4">
                        <div class="container-xl px-4">
                            <div class="page-header-content">
                                <div class="row align-items-center justify-content-between pt-3">
                                    <div class="col-auto mb-3">
                                        <h1 class="page-header-title">
                                            <div class="page-header-icon"><i class="fa-regular fa-comments"></i></div>
                                            Chat with Cleo
                                        </h1>
                                    </div>
                                    <div class="col-12 col-xl-auto mb-3 gap-5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>
                    <!-- Main container -->
                    <div class="container-xl px-4 mt-4">
                        <div class="d-flex gap-4">
                            <!-- CHAT DELEN -->
                            <div class="flex-grow-1 d-flex flex-column p-4">
                                <div class="chat-box flex-grow-1 overflow-auto mb-3" id="chat-box">
                                    <!-- Meddelanden h√§r -->
                                </div>
                                <div class="chat-input d-flex">
                                    <input type="text" id="chat-input" class="form-control me-2" placeholder="Skriv ett meddelande...">
                                    <button id="send-btn" class="btn btn-dark">Skicka</button>
                                </div>
                            </div>

                            <!-- SIDOPANEL -->
                            <div class="chat-sidebar p-4 bg-white rounded shadow-sm d-flex flex-column">
                                <div class="text-center mb-4">
                                    <img src="{% static 'assets/img/cleo-icon.png' %}" width="72" class="mb-2" alt="Cleo">
                                    <h5 class="fw-bold mb-0">Cleo, AI-kollega<br>inom rekrytering</h5>
                                </div>

                                <div class="mb-4">
                                    <p class="text-uppercase text-muted small fw-bold mb-2">Kom ig√•ng med Cleo</p>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-light rounded-pill">‚ùì Tips p√• fr√•gor att st√§lla</button>
                                        <button class="btn btn-light rounded-pill">üß† Vad Cleo kan g√∂ra</button>
                                        <button class="btn btn-light rounded-pill">üîê Hur Cleo hanterar din data</button>
                                        <button class="btn btn-light rounded-pill">‚öôÔ∏è Hur Cleo tr√§nats</button>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <p class="text-uppercase text-muted small fw-bold mb-2">Chatthistorik</p>
                                    <div class="d-grid gap-2">
                                        <a href="#" class="chat-history-box">Text till en gammal chatt‚Ä¶</a>
                                        <a href="#" class="chat-history-box">En till gammal fr√•ga‚Ä¶</a>
                                    </div>
                                </div>

                                <div class="mt-auto pt-3 text-center">
                                    <button class="btn btn-dark rounded-pill w-100 py-2">Ny Chatt</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>

                        const cleoAvatar = "{% static 'assets/img/cleo-icon.png' %}";
                    
                        function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== "") {
                                const cookies = document.cookie.split(";");
                                for (let i = 0; i < cookies.length; i++) {
                                    const cookie = cookies[i].trim();
                                    if (cookie.substring(0, name.length + 1) === name + "=") {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                    
                        document.addEventListener("DOMContentLoaded", function () {
                            const sendBtn = document.getElementById("send-btn");
                            const chatBox = document.getElementById("chat-box");
                            const input = document.getElementById("chat-input");

                            // üîΩ Scrolla till botten vid sidladdning
                            setTimeout(() => {
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }, 100);

                            sendBtn.addEventListener("click", function () {
                                const userMessage = input.value.trim();
                                if (!userMessage) return;

                                appendMessage("user", userMessage);
                                input.value = "";

                                fetch("/api/chat-response/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCookie("csrftoken"),
                                    },
                                    body: JSON.stringify({ message: userMessage })
                                })
                                .then(response => {
                                    const reader = response.body.getReader();
                                    const decoder = new TextDecoder();

                                    const div = document.createElement("div");
                                    div.className = "d-flex mb-3 align-items-start";
                                    div.innerHTML = `
                                        <img src="${cleoAvatar}" class="me-2 rounded-circle" width="32" height="32">
                                        <div class="chat-bubble cleo">
                                            <div class="bubble-inner"></div>
                                        </div>
                                    `;
                                    chatBox.appendChild(div);
                                    const bubble = div.querySelector(".bubble-inner");

                                    let fullText = ""; // üëà Vi samlar hela svaret h√§r!
                                    let accumulated = "";

                                    function read() {
                                        reader.read().then(({ done, value }) => {
                                            if (done) {
                                                // ‚úÖ N√§r all text √§r f√§rdigstreamad ‚Äì rendera snyggt
                                                bubble.innerHTML = marked.parse(accumulated);
                                                chatBox.scrollTop = chatBox.scrollHeight;
                                                return;
                                            }

                                            const chunk = decoder.decode(value);
                                            accumulated += chunk;

                                            // üîÅ Visa som plain text medan det laddas
                                            bubble.innerHTML = safeParseMarkdown(accumulated);
                                            chatBox.scrollTop = chatBox.scrollHeight;
                                            read();
                                        });
                                    }
                                    read();
                                })
                                .catch(err => {
                                    appendMessage("cleo", "N√•got gick fel üò¢");
                                    console.error(err);
                                });
                            });

                            // ‚úÖ H√§r √§r appendMessage P√Ö R√ÑTT PLATS
                            function appendMessage(sender, text) {
                                const div = document.createElement("div");

                                if (sender === "cleo") {
                                    div.className = "d-flex mb-3 align-items-start";
                                    div.innerHTML = `
                                        <img src="${cleoAvatar}" class="me-2 rounded-circle" width="32" height="32">
                                        <div class="chat-bubble cleo">
                                            <div class="bubble-inner">
                                                ${text}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    div.className = "d-flex mb-3 justify-content-end";
                                    div.innerHTML = `
                                        <div class="chat-bubble user">
                                            <div class="bubble-inner">
                                                ${text}
                                            </div>
                                        </div>
                                    `;
                                }

                                chatBox.appendChild(div);
                                setTimeout(() => {
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                }, 50);
                            }

                            function safeParseMarkdown(text) {
                                // Exempel: hantera **bold** live
                                const openCount = (text.match(/\*\*/g) || []).length;

                                // Om antalet ** √§r j√§mnt: fetstil klar!
                                if (openCount % 2 === 0) {
                                    return marked.parse(text);
                                } else {
                                    // Avsluta med dummy-tecken som inte visas, f√∂r att inte bryta markdown-parsern
                                    return marked.parse(text + '**');
                                }
                            }
                        });
                    </script>
                {% endblock %}