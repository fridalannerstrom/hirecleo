{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard - Cleo{% endblock %}
{% block content %}
                    <header class="page-header page-header-compact page-header-light border-bottom bg-white mb-4">
                        <div class="container-xl px-4">
                            <div class="page-header-content">
                                <div class="row align-items-center justify-content-between pt-3">
                                    <div class="col-auto mb-3">
                                        <h1 class="page-header-title">
                                            <div class="page-header-icon"><i class="fa-regular fa-comments"></i></div>
                                            Chat with Cleo
                                        </h1>
                                    </div>
                                    <div class="col-12 col-xl-auto mb-3 gap-5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>
                    <!-- Main page content-->
                    <div class="container-xl px-4 mt-4">
                        <div class="chat-wrapper d-flex">
                            <!-- CHAT-DELEN -->
                            <div class="chat-main flex-grow-1 d-flex flex-column p-4">
                                <div class="chat-box flex-grow-1 overflow-auto mb-3" id="chat-box">
                                    <!-- Meddelanden h√§r -->
                                </div>
                                <div class="chat-input d-flex">
                                    <input type="text" id="chat-input" class="form-control me-2" placeholder="Skriv ett meddelande...">
                                    <button id="send-btn" class="btn btn-dark">Skicka</button>
                                </div>
                            </div>
                        
                            <!-- SIDOPANEL -->
                            <div class="chat-sidebar p-4 bg-white">
                                <div class="sticky-top">
                                    <div class="text-center mb-4">
                                        <img src="{% static 'assets/img/cleo-icon.png' %}" width="64">
                                        <h5 class="mt-2 fw-bold">Cleo, AI-kollega<br>inom rekrytering</h5>
                                    </div>
                                    <div class="mb-3">
                                        <p class="fw-bold">Kom ig√•ng med Cleo</p>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-secondary btn-sm">‚ùì Tips p√• fr√•gor att st√§lla</button>
                                            <button class="btn btn-outline-secondary btn-sm">üß† Vad Cleo kan g√∂ra</button>
                                            <button class="btn btn-outline-secondary btn-sm">üîê Hur Cleo hanterar din data</button>
                                            <button class="btn btn-outline-secondary btn-sm">‚öôÔ∏è Hur Cleo tr√§nats</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="fw-bold">Chatthistorik</p>
                                        <div class="list-group small">
                                            <a href="#" class="list-group-item list-group-item-action">En tidigare fr√•ga‚Ä¶</a>
                                            <a href="#" class="list-group-item list-group-item-action">En till fr√•ga‚Ä¶</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>

                        const cleoAvatar = "{% static 'assets/img/cleo-icon.png' %}";
                    
                        function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== "") {
                                const cookies = document.cookie.split(";");
                                for (let i = 0; i < cookies.length; i++) {
                                    const cookie = cookies[i].trim();
                                    if (cookie.substring(0, name.length + 1) === name + "=") {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                    
                        document.addEventListener("DOMContentLoaded", function () {
                            const sendBtn = document.getElementById("send-btn");
                            const chatBox = document.getElementById("chat-box");
                            const input = document.getElementById("chat-input");

                            // üîΩ Scrolla till botten vid sidladdning
                            setTimeout(() => {
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }, 100);

                            sendBtn.addEventListener("click", function () {
                                const userMessage = input.value.trim();
                                if (!userMessage) return;

                                appendMessage("user", userMessage);
                                input.value = "";

                                fetch("/api/chat-response/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCookie("csrftoken"),
                                    },
                                    body: JSON.stringify({ message: userMessage })
                                })
                                .then(response => {
                                    const reader = response.body.getReader();
                                    const decoder = new TextDecoder();

                                    const div = document.createElement("div");
                                    div.className = "d-flex mb-3 align-items-start";
                                    div.innerHTML = `
                                        <img src="${cleoAvatar}" class="me-2 rounded-circle" width="32" height="32">
                                        <div class="chat-bubble cleo">
                                            <div class="bubble-inner"></div>
                                        </div>
                                    `;
                                    chatBox.appendChild(div);
                                    const bubble = div.querySelector(".bubble-inner");

                                    let fullText = ""; // üëà Vi samlar hela svaret h√§r!
                                    let accumulated = "";

                                    function read() {
                                        reader.read().then(({ done, value }) => {
                                            if (done) {
                                                // ‚úÖ N√§r all text √§r f√§rdigstreamad ‚Äì visa som HTML
                                                bubble.innerHTML = accumulated;
                                                chatBox.scrollTop = chatBox.scrollHeight;
                                                return;
                                            }

                                            const chunk = decoder.decode(value);
                                            accumulated += chunk;

                                            // üîÅ Visa tillf√§lligt som plain text (f√∂r effekten)
                                            bubble.textContent = accumulated;
                                            chatBox.scrollTop = chatBox.scrollHeight;
                                            read();
                                        });
                                    }

                                    read();
                                })
                                .catch(err => {
                                    appendMessage("cleo", "N√•got gick fel üò¢");
                                    console.error(err);
                                });
                            });

                            // ‚úÖ H√§r √§r appendMessage P√Ö R√ÑTT PLATS
                            function appendMessage(sender, text) {
                                const div = document.createElement("div");

                                if (sender === "cleo") {
                                    div.className = "d-flex mb-3 align-items-start";
                                    div.innerHTML = `
                                        <img src="${cleoAvatar}" class="me-2 rounded-circle" width="32" height="32">
                                        <div class="chat-bubble cleo">
                                            <div class="bubble-inner">
                                                ${text}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    div.className = "d-flex mb-3 justify-content-end";
                                    div.innerHTML = `
                                        <div class="chat-bubble user">
                                            <div class="bubble-inner">
                                                ${text}
                                            </div>
                                        </div>
                                    `;
                                }

                                chatBox.appendChild(div);
                                setTimeout(() => {
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                }, 50);
                            }
                        });
                    </script>
                {% endblock %}